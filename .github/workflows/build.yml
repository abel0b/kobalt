name: build

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  build-unix:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        config: [release]
        include:
          - os: ubuntu-latest
            osname: "linux"
          - os: macos-latest
            osname: "macos"

    steps:
    - uses: actions/checkout@v2

    - name: Install premake
      run : |
        wget https://github.com/premake/premake-core/releases/download/v5.0.0-alpha15/premake-5.0.0-alpha15-${{ matrix.osname }}.tar.gz
        tar xvzf premake-5.0.0-alpha15-${{ matrix.osname }}.tar.gz

    - name: Generate project file
      run: ./premake5 gmake2

    - name: Compile
      run: make config=${{ matrix.config }} -j$(nproc)

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        config: [release]

    steps:
    - uses: actions/checkout@v2

    - name: Install premake
      run: |
        Invoke-WebRequest -Uri "https://github.com/premake/premake-core/releases/download/v5.0.0-alpha15/premake-5.0.0-alpha15-windows.zip" -OutFile "premake-5.0.0-alpha15-windows.zip"
        Expand-Archive -DestinationPath . -Path premake-5.0.0-alpha15-windows.zip


    - name: Generate project file
      run: ./premake5.exe --os=windows vs2019

    - name: Compile
      run: |
        .\tools\vsenv.ps1
        MSBuild.exe kobalt.sln -m -p:Configuration=${{ matrix.config }}
